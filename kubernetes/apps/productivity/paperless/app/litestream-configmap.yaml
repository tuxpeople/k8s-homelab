---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/v1/configmap_v1.json
apiVersion: v1
kind: ConfigMap
metadata:
  name: paperless-litestream-config
data:
  # Phase 2: Replicate from Longhorn location
  #
  # WICHTIG: Litestream retention löscht nur Snapshots INNERHALB einer Generation,
  # aber NICHT alte Generationen selbst. Das führt zu vollem MinIO Bucket.
  #
  # Lösung: MinIO Lifecycle Policy auf Bucket-Ebene konfiguriert:
  #   mc ilm add --expiry-days 7 minio-lab/litestream
  #
  # Dies löscht automatisch alle Objekte älter als 7 Tage auf Storage-Ebene.
  # Siehe: docs/backups.md und docs/services/applications-productivity.md
  litestream-replicate.yml: |
    dbs:
      - path: /data/db.sqlite3
        replicas:
          - name: minio
            type: s3
            endpoint: $${MINIO_ENDPOINT}
            bucket: $${MINIO_BUCKET}
            path: paperless
            force-path-style: true
            retention: 168h
            validation-interval: 24h
            sync-interval: 10s
  # Phase 2: Restore from MinIO to Longhorn
  litestream-restore.yml: |
    dbs:
      - path: /data/db.sqlite3
        replicas:
          - name: minio
            type: s3
            endpoint: $${MINIO_ENDPOINT}
            bucket: $${MINIO_BUCKET}
            path: paperless
            force-path-style: true
