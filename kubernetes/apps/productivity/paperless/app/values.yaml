# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/app-template-3.7.3/charts/other/app-template/values.schema.json

controllers:
  app:
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      main:
        image:
          repository: ghcr.io/paperless-ngx/paperless-ngx
          tag: 2.20.8@sha256:e231ec11a1907bfdf172b4f120b4ef1994feb71e6cc624e8b88c53e2da3dfb62
        envFrom:
          - configMapRef:
              name: paperless-config
        env:
          PAPERLESS_SECRET_KEY:
            valueFrom:
              secretKeyRef:
                name: paperless-secret-values
                key: PAPERLESS_SECRET_KEY
          PAPERLESS_URL: https://{{ .Release.Name }}.${SECRET_DOMAIN}
          PAPERLESS_PORT: "8080"
          PAPERLESS_TIME_ZONE: ${TIMEZONE}
          # Configure admin user
          PAPERLESS_ADMIN_USER:
            valueFrom:
              secretKeyRef:
                name: paperless-secret-values
                key: PAPERLESS_ADMIN_USER
          PAPERLESS_ADMIN_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: paperless-secret-values
                key: PAPERLESS_ADMIN_PASSWORD
        probes:
          liveness:
            enabled: true
            spec:
              failureThreshold: 30
              periodSeconds: 10
          readiness:
            enabled: true
            spec:
              failureThreshold: 30
              periodSeconds: 10
          startup:
            enabled: true
            spec:
              failureThreshold: 180
              periodSeconds: 10
        resources:
          requests:
            cpu: 2000m
            memory: 2500Mi
          limits:
            cpu: 4000m
            memory: 4Gi
      litestream:
        image:
          repository: docker.io/litestream/litestream
          tag: 0.5.8
        args: ["replicate"]
        env:
          LITESTREAM_ACCESS_KEY_ID:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-access-key-id
          LITESTREAM_SECRET_ACCESS_KEY:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-secret-access-key
          S3_ENDPOINT:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-endpoint
          S3_BUCKET:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-bucket
          S3_REGION:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-region
        resources:
          requests:
            cpu: 10m
            memory: 50Mi
          limits:
            cpu: 500m
            memory: 512Mi
    initContainers:
      01-litestream-restore:
        image:
          repository: docker.io/litestream/litestream
          tag: 0.5.8
        args: ["restore", "-if-db-not-exists", "-if-replica-exists", "/data/db.sqlite3"]
        env:
          LITESTREAM_ACCESS_KEY_ID:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-access-key-id
          LITESTREAM_SECRET_ACCESS_KEY:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-secret-access-key
          S3_ENDPOINT:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-endpoint
          S3_BUCKET:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-bucket
          S3_REGION:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-s3-region
  redis:
    containers:
      redis:
        image:
          repository: docker.io/valkey/valkey
          tag: 9.0.2
        resources:
          requests:
            cpu: 23m
            memory: 100Mi
          limits:
            cpu: 150m
            memory: 120Mi
  tika:
    containers:
      tika:
        image:
          repository: docker.io/apache/tika
          tag: 3.2.3.0-full
        resources:
          requests:
            cpu: 15m
            memory: 308Mi
          limits:
            cpu: 500m
            memory: 500Mi
  gotenberg:
    containers:
      gotenberg:
        image:
          repository: docker.io/gotenberg/gotenberg
          tag: 8.26.0@sha256:328551506b3dec3ff6381dd47e5cd72a44def97506908269e201a8fbfa1c12c0
        env:
          DISABLE_GOOGLE_CHROME: "1"
        resources:
          requests:
            cpu: 15m
            memory: 334Mi
          limits:
            cpu: 500m
            memory: 503Mi
service:
  app:
    primary: true
    controller: app
    ports:
      http:
        port: &port 8080
  redis:
    controller: redis
    ports:
      http:
        port: 6379
  tika:
    controller: tika
    ports:
      http:
        port: 9998
  gotenberg:
    controller: gotenberg
    ports:
      http:
        port: 3000
ingress:
  app:
    enabled: true
    className: internal
    annotations:
      hajimari.io/icon: material-symbols:scanner-outline
      nginx.ingress.kubernetes.io/auth-method: GET
      nginx.ingress.kubernetes.io/auth-url: https://auth.${SECRET_DOMAIN}/api/verify
      nginx.ingress.kubernetes.io/auth-signin: https://auth.${SECRET_DOMAIN}?rm=$request_method
      nginx.ingress.kubernetes.io/auth-response-headers: Remote-User,Remote-Name,Remote-Groups,Remote-Email
      nginx.ingress.kubernetes.io/auth-snippet: |
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Scheme $scheme;
    hosts:
      - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: app
              port: http
    tls:
      - hosts:
          - *host
        secretName: ${SECRET_DOMAIN/./-}-production-tls
  public:
    enabled: true
    className: external
    annotations:
      gatus.io/enabled: "false"
      hajimari.io/enable: "false"
    hosts:
      - host: &host2 "documents.${SECRET_CH_DOMAIN}"
        paths:
          - path: /share
            pathType: Prefix
            service:
              identifier: app
              port: http
    tls:
      - hosts:
          - *host2
        secretName: ${SECRET_CH_DOMAIN/./-}-production-tls
persistence:
  nfs:
    type: nfs
    server: 10.20.30.40
    path: /volume2/scanner
  scripts:
    type: configMap
    name: paperless-scripts
    defaultMode: 0775
    globalMounts:
      - path: /usr/src/paperless/scripts
  passwords:
    type: secret
    name: paperless-passwords
    globalMounts:
      - path: /usr/src/paperless/passwords/passwords.txt
        subPath: passwords.txt
        readOnly: true
        # - path: /usr/src/paperless/scripts/pre-consume.sh
        #   subPath: pre-consume.sh
        # - path: /usr/src/paperless/scripts/remove-blank-pages.sh
        #   subPath: remove-blank-pages.sh
  litestream-config:
    type: configMap
    name: paperless-litestream-config
    advancedMounts:
      app:
        litestream:
          - subPath: litestream-replicate.yml
            path: /etc/litestream.yml
            readOnly: true
        01-litestream-restore:
          - subPath: litestream-restore.yml
            path: /etc/litestream.yml
            readOnly: true
  database:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ${MAIN_SC}
    accessMode: ReadWriteOnce
    size: 15Gi
    advancedMounts:
      app:
        main:
          - path: /data
        litestream:
          - path: /data
        01-litestream-restore:
          - path: /data
