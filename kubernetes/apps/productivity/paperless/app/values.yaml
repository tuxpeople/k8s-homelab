# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/app-template-3.7.3/charts/other/app-template/values.schema.json

controllers:
  app:
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      main:
        image:
          repository: docker.io/litestream/litestream
          tag: 0.5.2
        args: ["replicate"]
        env:
          LITESTREAM_ACCESS_KEY_ID:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-minio-id
          LITESTREAM_SECRET_ACCESS_KEY:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-minio-key
          MINIO_ENDPOINT:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-minio-endpoint
          MINIO_BUCKET:
            valueFrom:
              secretKeyRef:
                name: paperless-secrets
                key: litestream-minio-bucket
        resources:
          requests:
            cpu: 10m
            memory: 50Mi
          limits:
            cpu: 500m
            memory: 128Mi
  # Phase 2: Add init container for restore after initial backup is complete
  redis:
    containers:
      redis:
        image:
          repository: docker.io/valkey/valkey
          tag: 9.0.0
        resources:
          requests:
            cpu: 23m
            memory: 100Mi
          limits:
            cpu: 150m
            memory: 120Mi
  tika:
    containers:
      tika:
        image:
          repository: docker.io/apache/tika
          tag: 3.2.3.0-full
        resources:
          requests:
            cpu: 15m
            memory: 308Mi
          limits:
            cpu: 500m
            memory: 500Mi
  gotenberg:
    containers:
      gotenberg:
        image:
          repository: docker.io/gotenberg/gotenberg
          tag: 8.25.1@sha256:f9104080d9a7ecab253fb5ebe75100329cf5699c33ec0448f2ea02d885dfde4b
        env:
          DISABLE_GOOGLE_CHROME: "1"
        resources:
          requests:
            cpu: 15m
            memory: 334Mi
          limits:
            cpu: 500m
            memory: 503Mi
service:
  app:
    primary: true
    controller: app
    ports:
      http:
        port: &port 8080
  redis:
    controller: redis
    ports:
      http:
        port: 6379
  tika:
    controller: tika
    ports:
      http:
        port: 9998
  gotenberg:
    controller: gotenberg
    ports:
      http:
        port: 3000
ingress:
  app:
    enabled: true
    className: internal
    annotations:
      hajimari.io/icon: material-symbols:scanner-outline
      nginx.ingress.kubernetes.io/auth-method: GET
      nginx.ingress.kubernetes.io/auth-url: https://auth.${SECRET_DOMAIN}/api/verify
      nginx.ingress.kubernetes.io/auth-signin: https://auth.${SECRET_DOMAIN}?rm=$request_method
      nginx.ingress.kubernetes.io/auth-response-headers: Remote-User,Remote-Name,Remote-Groups,Remote-Email
      nginx.ingress.kubernetes.io/auth-snippet: |
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Scheme $scheme;
    hosts:
      - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: app
              port: http
    tls:
      - hosts:
          - *host
        secretName: ${SECRET_DOMAIN/./-}-production-tls
  public:
    enabled: true
    className: external
    annotations:
      gatus.io/enabled: "false"
      hajimari.io/enable: "false"
    hosts:
      - host: &host2 "documents.${SECRET_CH_DOMAIN}"
        paths:
          - path: /share
            pathType: Prefix
            service:
              identifier: app
              port: http
    tls:
      - hosts:
          - *host2
        secretName: ${SECRET_CH_DOMAIN/./-}-production-tls
persistence:
  nfs:
    type: nfs
    server: 10.20.30.40
    path: /volume2/scanner
  scripts:
    type: configMap
    name: paperless-scripts
    defaultMode: 0775
    globalMounts:
      - path: /usr/src/paperless/scripts
  passwords:
    type: secret
    name: paperless-passwords
    globalMounts:
      - path: /usr/src/paperless/passwords/passwords.txt
        subPath: passwords.txt
        readOnly: true
        # - path: /usr/src/paperless/scripts/pre-consume.sh
        #   subPath: pre-consume.sh
        # - path: /usr/src/paperless/scripts/remove-blank-pages.sh
        #   subPath: remove-blank-pages.sh
  litestream-config:
    type: configMap
    name: paperless-litestream-config
    advancedMounts:
      app:
        main:
          - subPath: litestream-replicate.yml
            path: /etc/litestream.yml
            readOnly: true
  database:
    enabled: true
    type: persistentVolumeClaim
    storageClass: longhorn
    accessMode: ReadWriteOnce
    size: 5Gi
    advancedMounts:
      app:
        main:
          - path: /database
