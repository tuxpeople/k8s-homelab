# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/app-template-3.7.3/charts/other/app-template/values.schema.json

controllers:
  miniflux:
    strategy: RollingUpdate
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: ghcr.io/miniflux/miniflux
          tag: 2.2.12-distroless@sha256:739450e87b1b0d7c124062f7433d1bb9ff9f6ab965637c27fbd373e3d0a5547e
        env:
          BASE_URL: https://{{ .Release.Name }}.${SECRET_DOMAIN}
          CREATE_ADMIN: "1"
          # DEBUG: "1"
          LOG_DATE_TIME: "1"
          METRICS_ALLOWED_NETWORKS: 10.42.0.0/16
          METRICS_COLLECTOR: "1"
          POLLING_SCHEDULER: entry_frequency
          POLLING_FREQUENCY: "15"
          PORT: &port 80
          RUN_MIGRATIONS: "1"
        probes:
          liveness: &probes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /healthcheck
                port: *port
              initialDelaySeconds: 0
              periodSeconds: 10
              timeoutSeconds: 1
              failureThreshold: 3
          readiness: *probes
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities: { drop: ["ALL"] }
        resources:
          requests:
            cpu: 10m
          limits:
            memory: 512Mi
defaultPodOptions:
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    runAsGroup: 65534
    seccompProfile: { type: RuntimeDefault }
service:
  app:
    controller: miniflux
    ports:
      http:
        port: *port
serviceMonitor:
  app:
    serviceName: miniflux
    endpoints:
      - port: http
        scheme: http
        path: /metrics
        interval: 1m
        scrapeTimeout: 10s
ingress:
  app:
    enabled: true
    className: external
    annotations:
      hajimari.io/icon: mdi:rss
    hosts:
      - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: app
              port: *port
    tls:
      - hosts:
          - *host
        secretName: ${SECRET_DOMAIN/./-}-production-tls
