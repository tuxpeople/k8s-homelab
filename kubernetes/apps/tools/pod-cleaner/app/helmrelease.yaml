---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app pod-cleaner
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controller:
      type: cronjob

      cronjob:
        schedule: "0 */6 * * *" # alle 6 Stunden

      containers:
        main:
          image:
            repository: registry.eighty-three.me/tuxpeople
            tag: v3.2.0
          command:
            - /bin/sh
            - -c
            - |
              AGE_HOURS=6
              NOW=$(date +%s)
              kubectl get pods --all-namespaces --field-selector=status.phase==Succeeded -o json | \
                jq -r '.items[] | "\(.metadata.namespace) \(.metadata.name) \(.status.startTime)"' | while read namespace name startTime; do
                  pod_time=$(date -d "$startTime" +%s)
                  age_hours=$(( (NOW - pod_time) / 3600 ))
                  if [ "$age_hours" -ge "$AGE_HOURS" ]; then
                      echo "Deleting pod $name in namespace $namespace (age: ${age_hours}h)"
                      kubectl delete pod "$name" -n "$namespace"
                  fi
                done

      serviceAccount:
        create: true
        name: pod-cleaner-sa

      rbac:
        create: true
        rules:
          - apiGroups: [""]
            resources: ["pods"]
            verbs: ["list", "delete"]

    # Optional: Logging
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
