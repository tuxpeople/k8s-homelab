apiVersion: v1
kind: ConfigMap
metadata:
  name: git-sync-config
data:
  GIT_SYNC_REPO: "https://github.com/your-org/airgapped-tools-config.git"
  GIT_SYNC_BRANCH: "main"
  GIT_SYNC_ROOT: "/git-sync"
  GIT_SYNC_DEST: "config"
  GIT_SYNC_USERNAME: "git"
  GIT_SYNC_MAX_SYNC_FAILURES: "3"

---
apiVersion: v1
kind: Secret
metadata:
  name: github-credentials
type: Opaque
data:
  # Base64 encoded values
  github-token: "" # echo -n "your-github-token" | base64
  git-password: "" # echo -n "your-git-token" | base64

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: packages-storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airgapped-tools-server
  labels:
    app: airgapped-tools-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: airgapped-tools-server
  template:
    metadata:
      labels:
        app: airgapped-tools-server
    spec:
      imagePullSecrets:
        - name: airgapped-tools-updater-pullsecret
      initContainers:
        # 1. Git Sync Pull - Download current config
        - name: git-sync-pull
          image: registry.k8s.io/git-sync/git-sync:v4.2.3
          command: ["/git-sync"]
          args:
            - --repo=$(GIT_SYNC_REPO)
            - --branch=$(GIT_SYNC_BRANCH)
            - --root=$(GIT_SYNC_ROOT)
            - --dest=$(GIT_SYNC_DEST)
            - --one-time
            - --v=2
          env:
            - name: GIT_SYNC_REPO
              valueFrom:
                configMapKeyRef:
                  name: git-sync-config
                  key: GIT_SYNC_REPO
            - name: GIT_SYNC_BRANCH
              valueFrom:
                configMapKeyRef:
                  name: git-sync-config
                  key: GIT_SYNC_BRANCH
            - name: GIT_SYNC_ROOT
              valueFrom:
                configMapKeyRef:
                  name: git-sync-config
                  key: GIT_SYNC_ROOT
            - name: GIT_SYNC_DEST
              valueFrom:
                configMapKeyRef:
                  name: git-sync-config
                  key: GIT_SYNC_DEST
            - name: GIT_SYNC_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: git-sync-config
                  key: GIT_SYNC_USERNAME
            - name: GIT_SYNC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: github-credentials
                  key: git-password
          volumeMounts:
            - name: git-sync-volume
              mountPath: /git-sync
            - name: app-config
              mountPath: /app/config

        # 2. Tools Updater - Download packages and update config
        - name: tools-updater
          image: airgapped-tools-updater:latest
          command: ["python", "airgapped_tools_updater.py", "--package"]
          env:
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-credentials
                  key: github-token
            - name: PYTHONUNBUFFERED
              value: "1"
          volumeMounts:
            - name: app-config
              mountPath: /app/config
            - name: packages-volume
              mountPath: /app/packages
            - name: downloads-volume
              mountPath: /app/downloads

        # 3. Git Sync Push - Commit updated config
        - name: git-sync-push
          image: registry.k8s.io/git-sync/git-sync:v4.2.3
          command: ["/bin/sh"]
          args:
            - -c
            - |
              set -e
              echo "Setting up Git credentials..."
              cd /git-sync/config
              git config user.name "Airgapped Tools Updater"
              git config user.email "tools-updater@kubernetes.local"

              echo "Copying updated config..."
              cp /app/config/tools_config.json ./tools_config.json

              echo "Checking for changes..."
              if git diff --quiet; then
                echo "No changes to commit"
                exit 0
              fi

              echo "Committing changes..."
              git add tools_config.json
              git commit -m "Auto-update tool versions - $(date '+%Y-%m-%d %H:%M:%S')"

              echo "Pushing to remote..."
              git push https://${GIT_SYNC_USERNAME}:${GIT_SYNC_PASSWORD}@$(echo ${GIT_SYNC_REPO} | sed 's|https://||') ${GIT_SYNC_BRANCH}

              echo "Git sync push completed successfully"
          env:
            - name: GIT_SYNC_REPO
              valueFrom:
                configMapKeyRef:
                  name: git-sync-config
                  key: GIT_SYNC_REPO
            - name: GIT_SYNC_BRANCH
              valueFrom:
                configMapKeyRef:
                  name: git-sync-config
                  key: GIT_SYNC_BRANCH
            - name: GIT_SYNC_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: git-sync-config
                  key: GIT_SYNC_USERNAME
            - name: GIT_SYNC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: github-credentials
                  key: git-password
          volumeMounts:
            - name: git-sync-volume
              mountPath: /git-sync
            - name: app-config
              mountPath: /app/config

      containers:
        # 4. HTTP Server - Serve packages for download
        - name: package-server
          image: python:3.11-slim
          command: ["python", "-m", "http.server"]
          args: ["8080"]
          workingDir: /packages
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: packages-volume
              mountPath: /packages
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"

      volumes:
        - name: git-sync-volume
          emptyDir: {}
        - name: app-config
          emptyDir: {}
        - name: packages-volume
          persistentVolumeClaim:
            claimName: packages-storage
        - name: downloads-volume
          emptyDir: {}

      restartPolicy: Always

---
apiVersion: v1
kind: Service
metadata:
  name: airgapped-tools-server
  labels:
    app: airgapped-tools-server
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: airgapped-tools-server

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: airgapped-tools-updater
spec:
  schedule: "0 2 * * *" # Daily at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: default
          containers:
            - name: restart-deployment
              image: bitnami/kubectl:latest
              command:
                - /bin/sh
                - -c
                - |
                  echo "Triggering airgapped-tools-server restart for updates..."
                  kubectl rollout restart deployment/airgapped-tools-server
                  echo "Restart triggered successfully"
          restartPolicy: OnFailure
      successfulJobsHistoryLimit: 3
      failedJobsHistoryLimit: 1

---
# Optional: Ingress for external access
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: airgapped-tools-server
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
    - host: airgapped-tools.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: airgapped-tools-server
                port:
                  number: 80
