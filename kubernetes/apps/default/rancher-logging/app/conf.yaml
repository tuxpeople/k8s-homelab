---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rsyslog-custom
data:
  custom.conf: |
    # This file created from k8s configmap
    $template RemoteStore, "/var/log/remote/%$year%/%$Month%/%$Day%/%$Hour%.log"
    :source, !isequal, "localhost" -?RemoteStore
    :source, isequal, "last" ~
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rsyslog-deployment
  labels:
    app: rsyslog
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rsyslog
  template:
    metadata:
      labels:
        app: rsyslog
    spec:
      containers:
        - name: rsyslog
          image: instantlinux/rsyslogd:latest
          resources:
            requests:
              cpu: 50m
              memory: 32Mi
            limits:
              cpu: 500m
              memory: 320Mi
          ports:
            - containerPort: 514
              name: udp
              protocol: UDP
            - containerPort: 514
              name: tcp
              protocol: TCP
          volumeMounts:
            - name: test-volume
              mountPath: /var/log
            - mountPath: /etc/rsyslog.d
              name: config
      volumes:
        - name: test-volume
          persistentVolumeClaim:
            claimName: test
        - name: config
          configMap:
            name: rsyslog-custom
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 25Gi
  storageClassName: local-path
---
apiVersion: v1
kind: Service
metadata:
  name: "syslog-service-tcp"
spec:
  ports:
    - port: 514
      targetPort: 514
      protocol: TCP
  selector:
    app: "rsyslog"
---
apiVersion: v1
kind: Service
metadata:
  name: "syslog-service-udp"
spec:
  ports:
    - port: 514
      targetPort: 514
      protocol: UDP
  selector:
    app: "rsyslog"
---
apiVersion: logging.banzaicloud.io/v1beta1
kind: Output
metadata:
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
  name: syslog-output
spec:
  syslog:
    buffer:
      flush_interval: 60s
      timekey: 10s
      timekey_wait: 0s
      timekey_use_utc: false
      timekey_zone: Europe/Zurich
    format:
      app_name_field: kubernetes.pod_name
      hostname_field: custom-cluster-name
      log_field: message
      rfc6587_message_size: false
    host: syslog-service-udp.default.svc.cluster.local
    insecure: true
    port: 514
    transport: udp
---
apiVersion: logging.banzaicloud.io/v1beta1
kind: Flow
metadata:
  name: flow-test
spec:
  filters:
    - tag_normaliser: {}
  localOutputRefs:
    - syslog-output
  match:
    - select:
        labels:
          app.kubernetes.io/name: echo-server
