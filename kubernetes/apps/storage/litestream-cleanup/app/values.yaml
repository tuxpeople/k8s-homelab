# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/app-template-3.7.3/charts/other/app-template/values.schema.json

controllers:
  main:
    type: cronjob

    cronjob:
      schedule: "0 2 * * 0"  # Sonntags um 2 Uhr
      concurrencyPolicy: Forbid
      successfulJobsHistoryLimit: 1
      failedJobsHistoryLimit: 2

    containers:
      main:
        image:
          repository: minio/mc
          tag: latest
        command:
          - /bin/sh
          - -c
          - |
            set -e
            echo "=== Litestream Cleanup Job Started ==="
            echo "Timestamp: $(date)"
            echo "Retention Days: ${RETENTION_DAYS}"

            # Configure mc alias for Garage
            echo "Configuring mc alias 'garage'..."
            mc alias set garage ${S3_ENDPOINT} ${S3_ACCESS_KEY} ${S3_SECRET_KEY}

            # List current bucket contents (summary)
            echo ""
            echo "Current bucket size:"
            mc du garage/litestream/ || echo "Failed to get bucket size"

            # Remove objects older than RETENTION_DAYS
            echo ""
            echo "Removing objects older than ${RETENTION_DAYS} days from garage/litestream/"
            mc rm --recursive --force --older-than ${RETENTION_DAYS}d garage/litestream/ || echo "No objects older than ${RETENTION_DAYS} days found or cleanup failed"

            # Show updated bucket size
            echo ""
            echo "Updated bucket size:"
            mc du garage/litestream/ || echo "Failed to get bucket size"

            echo ""
            echo "=== Litestream Cleanup Job Completed ==="
        env:
          RETENTION_DAYS: "7"  # Zentrale Retention-Variable (muss mit Litestream sync sein!)
          S3_ENDPOINT:
            valueFrom:
              secretKeyRef:
                name: litestream-cleanup-secrets
                key: s3-endpoint
          S3_ACCESS_KEY:
            valueFrom:
              secretKeyRef:
                name: litestream-cleanup-secrets
                key: s3-access-key
          S3_SECRET_KEY:
            valueFrom:
              secretKeyRef:
                name: litestream-cleanup-secrets
                key: s3-secret-key
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            cpu: 500m
            memory: 512Mi

# Service Account nicht notwendig - keine Kubernetes API calls
