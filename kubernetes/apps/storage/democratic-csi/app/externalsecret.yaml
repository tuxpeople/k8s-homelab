---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: synology-iscsi-driver-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: democratic-csi-driver-config
    creationPolicy: Owner
    template:
      data:
        driver-config-file.yaml: |
          driver: synology-iscsi

          # Synology DSM API connection settings
          httpConnection:
            protocol: http
            allowInsecure: true
            host: {{ .dsm_host }}
            username: {{ .dsm_user }}
            password: {{ .dsm_password }}
            port: 5000
            session: "democratic-csi"
            serialize: true

          iscsi:
            targetPortal: {{ .dsm_host }}
            baseiqn: "iqn.2000-01.com.synology:csi."

            lunTemplate:
              # Btrfs thin-provisioned LUN with snapshot support
              type: "BLUN"
              # Store PV ID in description for identification
              description: "{{`{{ parameters.[csi.storage.k8s.io/pv/name] }}`}}"
              dev_attribs:
                # Forced Unit Access for database durability
                - dev_attrib: emulate_fua_write
                  enable: 1
                # Space reclamation (TRIM/UNMAP)
                - dev_attrib: emulate_tpu
                  enable: 1
                # Thin Provisioning Write Same
                - dev_attrib: emulate_tpws
                  enable: 1
                # SCSI SYNCHRONIZE CACHE support
                - dev_attrib: emulate_sync_cache
                  enable: 1

            # Required by Synology API for snapshot creation
            lunSnapshotTemplate:
              # Allow snapshot deletion
              is_locked: false
              # We don't have Synology Storage Console for app-consistent snapshots
              is_app_consistent: false

            # iSCSI target configuration
            targetTemplate:
              # Disable CHAP authentication
              auth_type: 0
          synology:
            datasetProperties: {}
            volume: /volume2

  dataFrom:
    - extract:
        key: synology-iscsi-driver-secrets
