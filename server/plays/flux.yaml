---
- name: Flux Bootstrap
  hosts: k3s_master[0]

  tasks:
    - name: Create temporary file
      ansible.builtin.tempfile:
        state: file
        suffix: temp
      register: tmp_kubeconfig
      delegate_to: localhost
      become: false

    - name: Get Kubeconfig
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ tmp_kubeconfig.path }}"
        flat: yes
      when: tmp_kubeconfig.path is defined

    - name: Get certs
      ansible.builtin.fetch:
        src: "/var/lib/rancher/k3s/server/tls/{{ item }}"
        dest: "/tmp/{{ item }}"
        flat: yes
      with_items:
        - server-ca.crt
        - client-admin.crt
        - client-admin.key

    - name: Replace server address in kubeconfig
      replace:
        path: "{{ tmp_kubeconfig.path }}"
        regexp: '0.0.0.0:6443'
        replace: "{{ vrrp_vip }}:6443"
        backup: no
      when: tmp_kubeconfig.path is defined
      delegate_to: localhost
      become: false

    - name: Set cluster name in kubeconfig
      replace:
        path: "{{ tmp_kubeconfig.path }}"
        regexp: 'default'
        replace: "{{ cluster_name }}"
        backup: no
      when: tmp_kubeconfig.path is defined
      delegate_to: localhost
      become: false

    - name: Move kubeconfig in place
      command: "mv {{ tmp_kubeconfig.path }} {{ local_kubeconfig }}"
      when: tmp_kubeconfig.path is defined
      delegate_to: localhost
      become: false

    # - name: Copy additional Traefik-Config
    #   ansible.builtin.copy:
    #     src: ~/git/k8s-homelab/server/files/traefik-config.yaml
    #     dest: /var/lib/rancher/k3s/server/manifests/traefik-config.yaml
    #     owner: root
    #     group: root
    #     mode: "0600"

    - name: Remove the temporary file
      ansible.builtin.file:
        path: "{{ tmp_kubeconfig.path }}"
        state: absent
      when: tmp_kubeconfig.path is defined
      delegate_to: localhost
      become: false

    - name: Copy Sealed Secrets key
      ansible.builtin.copy:
        src: "{{ sealed_secrets_key }}"
        dest: /tmp/sealed_secrets_key.yaml
        owner: root
        group: root
        mode: "0600"

    - name: deploy Sealed Secrets key
      shell: "/usr/local/bin/kubectl apply -f /tmp/sealed_secrets_key.yaml && rm -f /tmp/sealed_secrets_key.yaml"
      ignore_errors: true

    - name: Bootstrap Flux
      shell: "flux bootstrap github --owner={{ github_user }} --repository={{ github_repo }} --branch=master --personal=true  --private=false --path=cluster/base --private-key-file=~/.ssh/id_rsa_github"
      delegate_to: localhost
      become: false
      environment:
        KUBECONFIG: "{{ local_kubeconfig }}"
        GITHUB_TOKEN: "{{ github_token }}"
