---
- name: Basis configuration for k3s_cluster
  hosts: k3s_cluster

  tasks:
    - name: Add Pod-Network to trusted zone
      ansible.posix.firewalld:
        source: "10.42.0.0/16"
        zone: trusted
        state: enabled
        immediate: yes
        permanent: yes
      when: ansible_os_family == "RedHat"

    - name: Add Services-Network to trusted zone
      ansible.posix.firewalld:
        source: "10.43.0.0/16"
        zone: trusted
        state: enabled
        immediate: yes
        permanent: yes
      when: ansible_os_family == "RedHat"

    # https://github.com/k3s-io/k3s/issues/1900
    - name: crictl cleanup as a systemd unit
      blockinfile:
        path: /etc/systemd/system/crictl-cleanup.service
        create: yes
        block: |
          [Unit]
          Description=crictl cleanup
          Requires=crictl.service
          After=crictl.service

          [Service]
          Type=oneshot
          WorkingDirectory=/tmp
          User=root
          Group=root
          ExecStart=/usr/local/bin/k3s crictl rmi --prune > /dev/null 2>&1

          [Install]
          WantedBy=multi-user.target

    - name: crictl cleanup systemd timer
      blockinfile:
        path: /etc/systemd/system/crictl-cleanup.timer
        create: yes
        block: |
          [Unit]
          Description=crictl cleanup timer

          [Timer]
          OnUnitInactiveSec=12h

          [Install]
          WantedBy=timers.target

    - name: Ensure start of crictl cleanup timer
      ansible.builtin.systemd:
        state: started
        enabled: true
        daemon_reload: yes
        name: crictl-cleanup.timer

    - name: Ensure nfs client is installed
      package:
        name: "{{ lookup('vars', 'nfs_package_' + ansible_os_family | lower )}}"
        state: present

    - name: Mount Multimedia nfs share
      mount:
        path: /mnt/multimedia
        src: diskstation.home:/volume1/Multimedia
        opts: users,noauto,x-systemd.automount,x-systemd.mount-timeout=30,_netdev,timeo=14,noatime
        state: mounted
        fstype: nfs

    - name: Disable SWAP since kubernetes can't work with swap enabled (1/2)
      shell: |
        swapoff -a

    - name: Disable SWAP in fstab since kubernetes can't work with swap enabled (2/2)
      replace:
        path: /etc/fstab
        regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
        replace: '#\1\2\3swap\4'

  roles:
    - xanmanning.k3s
