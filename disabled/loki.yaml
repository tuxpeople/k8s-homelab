---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  chart:
    spec:
      chart: loki-stack
      interval: 5m
      sourceRef:
        kind: HelmRepository
        name: grafana-charts
        namespace: flux-system
      version: 2.4.1
  install:
    remediation:
      retries: 3
  interval: 5m
  upgrade:
    remediation:
      retries: 3
  values:
    alertmanager:
      enabled: true
    grafana:
      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
          - disableDeletion: false
            editable: true
            folder: unifi-poller
            name: unifi-poller
            options:
              path: /var/lib/grafana/dashboards/unifi-poller
            orgId: 1
            type: file
          - disableDeletion: false
            editable: true
            folder: kubernetes
            name: kubernetes
            options:
              path: /var/lib/grafana/dashboards/kubernetes
            orgId: 1
            type: file
          - disableDeletion: false
            editable: true
            folder: various
            name: various
            options:
              path: /var/lib/grafana/dashboards/various
            orgId: 1
            type: file
      dashboards:
        unifi-poller:
          up_client-dpi:
            datasource: Prometheus
            gnetId: 11310
            revision: 4
          up_client-insights:
            datasource: Prometheus
            gnetId: 11315
            revision: 8
          up_network-sites:
            datasource: Prometheus
            gnetId: 11311
            revision: 4
          up_uap_insights:
            datasource: Prometheus
            gnetId: 11314
            revision: 9
          up_usg_insights:
            datasource: Prometheus
            gnetId: 11313
            revision: 8
          up_usw_insights:
            datasource: Prometheus
            gnetId: 11312
            revision: 8
        various:
          flux-cluster:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/fluxcd/flux2/main/manifests/monitoring/grafana/dashboards/cluster.json
          flux-control-plane:
            datasource: Prometheus
            url: https://raw.githubusercontent.com/fluxcd/flux2/main/manifests/monitoring/grafana/dashboards/control-plane.json
          uptimerobot:
            datasource: Prometheus
            gnetId: 9955
            revision: 1
      defaultDashboardsEnabled: true
      enabled: true
      grafana.ini:
        server:
          root_url: https://grafana.${SECRET_DOMAIN}
      ingress:
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-production
          kubernetes.io/ingress.class: traefik
          traefik.ingress.kubernetes.io/redirect-entry-point: https
        enabled: true
        hosts:
        - grafana.${SECRET_DOMAIN}
        tls:
        - hosts:
          - grafana.${SECRET_DOMAIN}
          secretName: grafana-eighty-three-me-tls
      persistence:
        accessModes:
        - ReadWriteOnce
        enabled: true
        size: 10Gi
        type: pvc
      plugins:
      - grafana-piechart-panel
      sidecar:
        dashboards:
          enabled: true
          searchNamespace: ALL
        datasources:
          enabled: true
          searchNamespace: ALL
        provider:
          allowUiUpdates: true
          disableDelete: false
          folder: kubernetes
          foldersFromFilesStructure: false
          name: sidecarProvider
          orgid: 1
          type: file
    loki:
      config:
        table_manager:
          retention_deletes_enabled: true
          retention_period: 336h
      persistence:
        enabled: true
        size: 25Gi
      serviceMonitor:
        enabled: true
    prometheus:
      enabled: true
      ingress:
        annotations:
          kubernetes.io/ingress.class: traefik
        enabled: true
        hosts:
        - prometheus.${INTERNAL_DOMAIN}
      persistentVolume:
        enabled: true
        size: 10Gi
      serverFiles:
        prometheus.yaml:
          scrape_configs:
          - job_name: unifipoller
            scrape_interval: 30s
            static_configs:
            - targets:
              - unifi-poller:9130
          - job_name: uptimerobot-prometheus
            scrape_interval: 30s
            static_configs:
            - targets:
              - uptimerobot-prometheus:9705
          - job_name: kubernetes-service-endpoints
            kubernetes_sd_configs:
            - role: endpoints
            relabel_configs:
            - action: keep
              regex: true
              source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_scrape
            - action: replace
              regex: (https?)
              source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_scheme
              target_label: __scheme__
            - action: replace
              regex: (.+)
              source_labels:
              - __meta_kubernetes_service_annotation_prometheus_io_path
              target_label: __metrics_path__
            - action: replace
              regex: ([^:]+)(?::\d+)?;(\d+)
              replacement: $1:$2
              source_labels:
              - __address__
              - __meta_kubernetes_service_annotation_prometheus_io_port
              target_label: __address__
            - action: labelmap
              regex: __meta_kubernetes_service_label_(.+)
            - action: replace
              source_labels:
              - __meta_kubernetes_namespace
              target_label: kubernetes_namespace
            - action: replace
              source_labels:
              - __meta_kubernetes_service_name
              target_label: kubernetes_name
            - action: replace
              source_labels:
              - __meta_kubernetes_pod_node_name
              target_label: kubernetes_node
          - job_name: kubernetes-pods
            kubernetes_sd_configs:
            - role: pod
            relabel_configs:
            - action: keep
              regex: true
              source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scrape
            - action: replace
              regex: (https?)
              source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_scheme
              target_label: __scheme__
            - action: replace
              regex: (.+)
              source_labels:
              - __meta_kubernetes_pod_annotation_prometheus_io_path
              target_label: __metrics_path__
            - action: replace
              regex: ([^:]+)(?::\d+)?;(\d+)
              replacement: $1:$2
              source_labels:
              - __address__
              - __meta_kubernetes_pod_annotation_prometheus_io_port
              target_label: __address__
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)
            - action: replace
              source_labels:
              - __meta_kubernetes_namespace
              target_label: kubernetes_namespace
            - action: replace
              source_labels:
              - __meta_kubernetes_pod_name
              target_label: kubernetes_pod_name
            - action: drop
              regex: Pending|Succeeded|Failed
              source_labels:
              - __meta_kubernetes_pod_phase
    promtail:
      serviceMonitor:
        enabled: true
  valuesFrom:
  - kind: Secret
    name: grafanavalues
    secretKeyRef: null
