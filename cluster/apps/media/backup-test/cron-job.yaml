---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: backup-test
  labels:
    app: backup-test
spec:
  suspend: false
  schedule: "*/7 * * * *"
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                    - radarr
                topologyKey: "kubernetes.io/hostname"
          restartPolicy: OnFailure
          dnsPolicy: ClusterFirst
          containers:
          - name: backup-test
            image: alpine
            imagePullPolicy: Always
            env:
            - name: FILEPREFIX
              value: "radarr"
            - name: FILESUFFIX
              value: "$(date '+%Y%m%d%H%M%S')"
            - name: KEEP   # Number of file to keep +1
              value: "4"
            volumeMounts:
            - mountPath: /mnt/persistentvolume
              name: persistentvolume
            - mountPath: /mnt/target
              name: target
            ressources:
              requests:
                memory: 50Mi
                cpu: 50m
              limits:
                memory: 1000Mi
                cpu: 1000m
            args:
            - /bin/sh
            - -c
            - "cd /mnt/ && tar -czvf target/${FILEPREFIX}-${FILESUFFIX}.tar.gz persistentvolume && cd target && ls -t1 | tail -n +${KEEP} | xargs rm --"
          volumes:
          - name: persistentvolume
            persistentVolumeClaim:
              claimName: radarr-config
          - name: target
            nfs:
              server: 10.20.30.40
              path: "/volume1/Multimedia/backup"
