---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: backup-test
  labels:
    app: backup-test
spec:
  suspend: false
  schedule: "*/7 * * * *"
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                    - radarr
                topologyKey: "kubernetes.io/hostname"
          restartPolicy: OnFailure
          dnsPolicy: ClusterFirst
          containers:
          - name: backup-test
            image: alpine
            imagePullPolicy: Always
            volumeMounts:
            - mountPath: /mnt/source
              name: source
            - mountPath: /mnt/destination
              name: destination
            resources:
              requests:
                memory: 50Mi
                cpu: 50m
              limits:
                memory: 1000Mi
                cpu: 1000m
            args:
            - /bin/sh
            - -c
            - "cd /mnt/ && tar -czvf destination/radarr-$(date '+%Y%m%d%H%M%S').tar.gz source && cd destination && ls -t1 | tail -n +4 | xargs rm --"
          volumes:
          - name: source
            persistentVolumeClaim:
              claimName: radarr-config
          - name: destination
            nfs:
              server: 10.20.30.40
              path: "/volume1/Multimedia/backup"
