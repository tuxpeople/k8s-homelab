---
apiVersion: v1
kind: ConfigMap
metadata:
  name: script-configmap
data:
  backup.sh: |
    #!/bin/sh

    echo "Getting vars"
    SUFFIX=$(date '+%Y%m%d%H%M%S')
    TOKEEP=$((BACKUPNAME+1))

    echo "Do some checks"
    echo " - checking for target dir"
    [ -d /mnt/target ] || exit 1
    echo " - checking for source dir"
    [ -d /mnt/persistentvolume ] || exit 1

    echo "I will backup /mnt/persistentvolume to /mnt/target/${BACKUPNAME}-${SUFFIX}.tar.gz. I will delete all old backups except the last $(printenv KEEPFILES)"

    echo "Starting backup"
    cd /mnt/
    tar -czf target/${BACKUPNAME}-${SUFFIX}.tar.gz persistentvolume
    cd target

    echo "Cleanup old backups"
    COUNT="0"
    COUNT=$(ls -t1 ${BACKUPNAME}-* | tail -n +${KETOKEEPEP} | wc -l)

    if [ "${COUNT}" -lt "1" ];
    then
        echo "No cleanup needed"
    else
        echo "Cleaning up old backups, keeping last $(printenv KEEPFILES) files:"
        ls -t1 ${BACKUPNAME}-* | tail -n +${TOKEEP} | xargs rm -v --
    fi
