---
apiVersion: v1
kind: ConfigMap
metadata:
  name: script-configmap
data:
  backup.sh: |
    #!/bin/sh

    echo "Getting vars"
    SUFFIX=$(eval $TIMESTAMP)
    TOKEEP=$((KEEPFILES+1))

    echo "Do some checks"
    echo " - checking for target dir"
    [ -d /mnt/target ] || exit 1
    echo " - checking for source dir"
    [ -d /mnt/persistentvolume ] || exit 1

    echo "Starting backup of /mnt/persistentvolume to /mnt/target/$BACKUPNAME-$SUFFIX.tar.gz"
    cd /mnt/
    tar -czf target/$BACKUPNAME-$SUFFIX.tar.gz.tar.gz persistentvolume
    cd target

    echo "Cleanup old backups except the last $(printenv KEEPFILES)"
    COUNT="0"
    COUNT=$(ls -t1 | grep $BACKUPNAME | tail -n +$TOKEEP | wc -l)

    if [ "$COUNT" -lt "1" ];
    then
        echo "No cleanup needed"
    else
        echo "Cleaning up old backups, keeping last $KEEPFILES files:"
        ls -t1 | grep $BACKUPNAME | tail -n +$TOKEEP | xargs rm -v --
    fi
