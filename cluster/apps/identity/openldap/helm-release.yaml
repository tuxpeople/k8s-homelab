---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: openldap
  namespace: identity
spec:
  releaseName: openldap
  chart:
    spec:
      # renovate: registryUrl=https://jp-gouin.github.io/helm-openldap/
      chart: openldap-stack-ha
      version: 2.1.5
      sourceRef:
        kind: HelmRepository
        name: openldap
        namespace: flux-system
      interval: 5m
  interval: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    env:
      LDAP_ORGANISATION: "Tuxpeople"
      LDAP_DOMAIN: "sky.lab"
      LDAP_TLS: "true"
      LDAP_TLS_ENFORCE: "false"
      LDAP_REMOVE_CONFIG_AFTER_SETUP: "true"
      LDAP_READONLY_USER: "true"
    replicaCount: 1
    existingSecret: ldap-admin
    persistence:
      enabled: true
    customLdifFiles:
      initial-ous.ldif: |-
        dn: ou=People,dc=ssotest,dc=sky,dc=lab
        objectClass: organizationalUnit
        ou: People

        dn: ou=Group,dc=ssotest,dc=sky,dc=lab
        objectClass: organizationalUnit
        ou: Group
  valuesFrom:
  - secretKeyRef:
    kind: Secret
    name: openldap-secret-values
