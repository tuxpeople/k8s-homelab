name: Claude Code

on:
  # Automatic trigger on workflow failures
  workflow_run:
    workflows: ["Flux Local", "Mise", "ShellCheck", "Validation", "Check talconfig"]
    types: [completed]

  # Manual trigger via @claude comment
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, assigned]

jobs:
  claude:
    # Run for manual @claude mentions OR automatic workflow failures
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.event == 'pull_request')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Get PR number for workflow failures
        id: pr
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
            });

            if (prs.length > 0) {
              return prs[0].number;
            }
            return null;

      - name: Check if Claude already analyzed this PR
        id: claude-check
        if: github.event_name == 'workflow_run' && steps.pr.outputs.result != 'null'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            // Check if claude[bot] has already commented in the last 6 hours
            const sixHoursAgo = new Date(Date.now() - 6 * 60 * 60 * 1000);
            const recentClaudeComments = comments.filter(comment =>
              comment.user.login === 'claude[bot]' &&
              new Date(comment.created_at) > sixHoursAgo
            );

            if (recentClaudeComments.length > 0) {
              console.log(`Claude has already analyzed this PR ${recentClaudeComments.length} times in the last 6 hours. Skipping to prevent loop.`);
              return 'skip';
            }
            return 'run';

      - name: Add failure labels
        if: github.event_name == 'workflow_run' && steps.pr.outputs.result != 'null' && steps.claude-check.outputs.result != 'skip'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            await github.rest.issues.addLabels({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['ðŸ¤– needs-claude-fix', 'ðŸ”´ workflow-failed', 'ðŸ¤– claude-requested']
            });

      - name: Build prompt for workflow failures
        id: prompt
        if: github.event_name == 'workflow_run' && steps.claude-check.outputs.result != 'skip'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const workflowName = context.payload.workflow_run.name;
            const runUrl = context.payload.workflow_run.html_url;
            const prNumber = ${{ steps.pr.outputs.result }};

            // Get failed job logs
            const workflowRunId = context.payload.workflow_run.id;
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: workflowRunId,
            });

            let failedJobsInfo = '';
            for (const job of jobs.jobs) {
              if (job.conclusion === 'failure') {
                failedJobsInfo += `\n\nFailed Job: ${job.name}\nLog URL: ${job.html_url}`;
              }
            }

            const prompt = [
              `Analyze the ${workflowName} workflow failure on PR #${prNumber}.`,
              ``,
              `Workflow Run: ${runUrl}`,
              `${failedJobsInfo}`,
              ``,
              `Please:`,
              `1. Identify the root cause of the failure`,
              `2. Suggest specific fixes`,
              `3. If possible, implement the fixes directly`,
              ``,
              `IMPORTANT: When you've successfully resolved the issue:`,
              `- Add label "âœ… claude-fixed": gh pr edit ${prNumber} --add-label "âœ… claude-fixed"`,
              `- Remove old labels: gh pr edit ${prNumber} --remove-label "ðŸ¤– needs-claude-fix"`,
              `  --remove-label "ðŸ”´ workflow-failed"`,
              ``,
              `Note: You cannot push to Renovate branches. If you fix locally but can't push,`,
              `explain the fix in a comment for manual application.`
            ].join('\n');

            core.setOutput('prompt', prompt);

      - name: Checkout PR branch
        if: |
          github.event_name != 'workflow_run' ||
          (github.event_name == 'workflow_run' && steps.claude-check.outputs.result != 'skip')
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || '' }}
          fetch-depth: 0

      - name: Run Claude Code
        if: |
          github.event_name != 'workflow_run' ||
          (github.event_name == 'workflow_run' && steps.claude-check.outputs.result != 'skip')
        id: claude
        uses: anthropics/claude-code-action@b433f16b30d54063fd3bab6b12f46f3da00e41b6 # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Allow Claude to use necessary tools for analysis and fixes via claude_args
          # Using 'Bash' without restrictions for full tool access in CI environment
          claude_args: >-
            --allowed-tools 'Bash'
            --allowed-tools 'WebFetch'
            --allowed-tools 'Read'
            --allowed-tools 'Edit'
            --allowed-tools 'Write'
            --allowed-tools 'Grep'
            --allowed-tools 'Glob'

          # Use generated prompt for automatic triggers, otherwise Claude will use the user's comment
          prompt: ${{ steps.prompt.outputs.prompt }}
