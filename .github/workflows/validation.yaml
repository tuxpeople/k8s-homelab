---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Validation"

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  check-sops-encryption:
    name: Check SOPS Encryption
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check for unencrypted secrets
        run: |
          echo "üîç Checking for unencrypted secrets..."

          # Check for actual Secret resources (not just references)
          if find kubernetes/ -name "*.yaml" -not -name "*.sops.*" -exec grep -l "^kind: Secret" {} \; | grep -v "/tmp/"; then
            echo "‚ùå Found unencrypted Secret resources. All secrets should use .sops.yaml extension."
            exit 1
          fi

          # Check for common secret patterns (exclude references to secrets)
          echo "üîç Checking for potential hardcoded secrets..."
          potential_secrets=$(find kubernetes/ -name "*.yaml" -not -name "*.sops.*" \
            -exec grep -l -E "(password|token|secret):\s*['\"]?[a-zA-Z0-9]{8,}" {} \; | \
            grep -v -E "(externalsecret|secretstore|values\.yaml)" | head -5 || true)
          if [[ -n "$potential_secrets" ]]; then
            echo "‚ö†Ô∏è  Found potential hardcoded secrets that may need encryption:"
            echo "$potential_secrets"
            echo "Please review these files and encrypt any actual secrets."
          else
            echo "‚úÖ No potential hardcoded secrets found"
          fi

          # Verify SOPS encrypted files have ENC markers
          echo "üîç Checking SOPS encrypted files..."
          if invalid_sops=$(find kubernetes/ -name "*.sops.*" -exec grep -L "ENC\[AES256_GCM" {} \; 2>/dev/null | head -5); then
            if [[ -n "$invalid_sops" ]]; then
              echo "‚ùå Found .sops files without proper encryption markers:"
              echo "$invalid_sops"
              exit 1
            else
              echo "‚úÖ All .sops files are properly encrypted"
            fi
          fi

          echo "‚úÖ SOPS encryption check passed"

  validate-yaml:
    name: Validate YAML Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Cache mise tools
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.local/share/mise
          key: mise-${{ runner.os }}-${{ hashFiles('.mise.toml') }}

      - name: Setup mise
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          cache: false

      - name: Validate YAML syntax
        run: |
          echo "üîç Validating YAML syntax..."
          find . -name "*.yaml" -o -name "*.yml" | while read -r file; do
            if [[ "$file" == *".sops."* ]]; then
              echo "‚è≠Ô∏è  Skipping encrypted file: $file"
              continue
            fi
            echo "‚úÖ Validating: $file"
            yq eval '.' "$file" > /dev/null || {
              echo "‚ùå Invalid YAML syntax in: $file"
              exit 1
            }
          done

  validation-status:
    name: Validation Success
    needs: ["check-sops-encryption", "validate-yaml"]
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Any jobs failed?
        if: ${{ contains(needs.*.result, 'failure') }}
        run: exit 1

      - name: All jobs passed or skipped?
        if: ${{ !(contains(needs.*.result, 'failure')) }}
        run: echo "‚úÖ All validation checks passed or skipped" && echo "${{ toJSON(needs.*.result) }}"
